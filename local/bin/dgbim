#!/usr/local/bin/ruby
# require 'json/stream'
require 'json'
require 'uri'

# url = 'http://gb9.bimsop.com/peacock/1-1501661691279/1-1501661691279.gbim'
$GBIM_TEXTURE_PATH="http://gb9.bimsop.com/assets/m2/"

def downloadImage(uri)
  if uri.include?("##")
    uri = uri.gsub(/##/, "")
  end
  uri = uri.gsub(/\\/, "/")
  system 'wget', URI.encode($GBIM_TEXTURE_PATH + uri), '-P', $modelFolder + 'textures', :out=>:close, :err=>['/dev/null', 'a']
  puts $GBIM_TEXTURE_PATH + uri
end

url = ARGV[0]
if !url
  puts 'invalid argument, try -> dgbim http://gb9.bimsop.com/peacock/1-1501661691279/1-1501661691279.gbim'
elsif !url.respond_to?(:to_s)
  puts 'invalid argument, try -> dgbim http://gb9.bimsop.com/peacock/1-1501661691279/1-1501661691279.gbim'
else
  puts '----------------Downloading------------------'
  if url.end_with? '.gbim'
    decoded = URI.decode(url) # gbim url

    arr = decoded.split('/')
    $modelName = arr[arr.length - 1].sub('.gbim', '')
    infoUrl = decoded.sub('.gbim', '.sum.json')

    basePath = decoded.sub($modelName + '.gbim', '')
    $modelFolder="#{ENV["HOME"]}/Downloads/models/#{$modelName}/";

    # download_output = system "wget #{URI.encode(infoUrl)} -P #{$modelFolder}", :out=>:close, :err=>['/dev/null', 'a']
    # puts infoUrl

    download_output = system 'wget', URI.encode(decoded), '-P', $modelFolder, :out=>:close, :err=>['/dev/null', 'a']
    puts decoded

    if download_output

      system "wget #{URI.encode(decoded.sub('.gbim', '.pi'))} -P #{$modelFolder}", :out=>:close, :err=>['/dev/null','a']
      puts decoded.sub('.gbim', '.pi')

      system "wget #{URI.encode(decoded.sub('.gbim', '.pc'))} -P #{$modelFolder}", :out=>:close, :err=>['/dev/null','a']
      puts decoded.sub('.gbim', '.pc')

      # download images
      # puts $modelFolder + $modelName + '.gbim'
      gbimStr = File.read($modelFolder + $modelName + '.gbim')

      # puts gbimStr
      # gbim = JSON::Stream::Parser.parse(gbimStr);
      gbim = JSON.parse(gbimStr);
      images = gbim["images"];
      puts ''
      puts '---------------Checking Texture--------------'
      images.each { |index, imageInfo| downloadImage(imageInfo["uri"]) }

      # download buffers
      bufferCount = gbim["buffers"].length;
      count = 0
      puts ''
      puts '--------------Downloading Buffers-----------'
      while download_output
        break if count == bufferCount
        bin = ".#{count + 1}.bin"
        download_output = system "wget #{URI.encode(decoded.sub('.gbim', bin))} -P #{$modelFolder}", :out=>:close, :err=>['/dev/null','a']
        puts decoded.sub('.gbim', bin)
        count = count + 1
      end
      puts ''
      puts '------------------Finished-------------------'
    end
  end
end